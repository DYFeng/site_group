#!/bin/bash
cpu_affinity=""
cpu_num="8"
for (( i=1;i<=$cpu_num;i++ ));do
	for (( n=$cpu_num;n>0;n-- ));do
		if [ $n -eq $i ];then
			cpu_affinity=$cpu_affinity'1'
		else
			cpu_affinity=$cpu_affinity'0'
		fi
	done
	cpu_affinity=$cpu_affinity' '
done


sed -i "s/aaa/$cpu_affinity/g" a
exit 1

# Check if user is root
if [ $(id -u) != "0" ]; then
    echo "Error: You must be root to run this script, use sudo sh $0"
    exit 1
fi

clear
echo "========================================================================="
echo "Add Wordpress for LNMP V0.9 , Written by DY.Feng "
echo "========================================================================="
echo "LNMP is a tool to auto-compile & install Nginx+MySQL+PHP on Linux "
echo ""
echo "========================================================================="

domain_file="domains.txt"

echo "Please input domain file:" 
read -p "(Default domain file: domains.txt):" domain_file

if [ "$domain_file" = "" ]; then
	domain_file="domains.txt"
fi

if [ ! -f $domain_file ];then
	echo "Error: file $domain_file do not exist"
	exit 1
fi

echo "Please input wordpress folder:"
read -p "(Default wordpress folder: wordpress):" wordpress_folder

if [ "$wordpress_folder" = "" ]; then
	wordpress_folder="wordpress"
fi

if [ ! -d $wordpress_folder ];then
	echo "Error: wordpress folder $wordpress_folder do not exist"
	exit 1
fi

echo "Please input database host"
read -p "(Default host: localhost):" db_host

if [ "$db_host" = "" ]; then
	db_host="localhost"
fi

echo "Please input database username:"
read -p "(Default username: root):" db_username

if [ "$db_username" = "" ]; then
	db_username="root"
fi

echo "Please input database password:"
read -p "(Default password: "root"):" db_password

if [ "$db_password" = "" ]; then
	db_password="root"
fi

export db_host=$db_host
export db_username=$db_username
export db_password=$db_password

mysql_return=`php -q << 'EOF'
<?php
$db_host=getenv("db_host");
$db_username=getenv("db_username");
$db_password=getenv("db_password");
$conn = @mysql_connect("$db_host","$db_username","$db_password","mysql");
if ($conn)
{
echo "";
}
else{
echo mysql_error();
}

?>
EOF
`

if [ -n "$mysql_return" ];then
	mysql_info="Error:MySQL connection failed($mysql_return)"
	echo $mysql_info
	read -p "Do you want to continue?(y/n):" goon
	if [ "$goon" = 'n' ];then
		exit 1;
	fi
else
	mysql_info="Test:MySQL connection success"
	echo $mysql_info
fi




echo ""
echo "Demains:"
echo "==========================="


domains_ips=(`cat $domain_file`)

cat $domain_file | awk '$1=$1' | while read domain_ip;do
	domain=`echo $domain_ip | cut -d " " -f 1 |tr '[A-Z]' '[a-z]' `
	ip=`echo $domain_ip | cut -d " " -f 2`
	echo -e "$domain\t$ip\c"
	if [ ! -f "/usr/local/nginx/conf/vhost/$domain.conf" ]; then
		echo ""
	else
		echo "(Exist)"
	fi
done

echo ""
echo "Wordpress:"
echo "==========================="
echo "Folder:`realpath $wordpress_folder`"


echo ""
echo "Database:"
echo "==========================="
echo -e "Host:\t\t$db_host"
echo -e "User name:\t$db_username"
echo -e "Password:\t$db_password"
echo -e "Test result:\t$mysql_info"

echo "==========================="
echo "The scripts will create the wordpress site.(Existing will be overwritten)(y/n)"

read create_wordpress
if [ "$create_wordpress" != 'y' ]; then
	exit 1
fi

if [ ! -d /usr/local/nginx/conf/vhost ]; then
	mkdir /usr/local/nginx/conf/vhost
fi


for domain_ip in ${domains_ips[@]};do
	domain=`echo $domain_ip | cut -d ' ' -f 1`
	ip=`echo $domain_ip | cut -d ' ' -f 2`
	
	if [ $ip = '' ];then
		ip="127.0.0.1"
	fi
	
	vhostdir="/home/wwwroot/$domain"
	alf="log_format  $domain  '\$remote_addr - \$remote_user [\$time_local] "\$request" '
			'\$status \$body_bytes_sent "\$http_referer" '
			'"\$http_user_agent" \$http_x_forwarded_for';"
	al="access_log  /home/wwwlogs/$domain.log  $domain;"
	
	echo "Create Virtul Host directory......"
	mkdir -p $vhostdir
	touch /home/wwwlogs/$domain.log
	
	echo "Copy wordpress stuff......"
	cp -R $wordpress_folder/* $vhostdir
	
	echo "Set permissions of Virtual Host directory......"
	
	chmod -R 755 $vhostdir
	chown -R www:www $vhostdir

	cat >/usr/local/nginx/conf/vhost/$domain.conf<<EOF
$alf
server
{
	listen       $ip:80;
	server_name $domain;
	index index.html index.htm index.php default.html default.htm default.php;
	root  $vhostdir;

	include wordpress.conf;
	location ~ .*\.(php|php5)?$
	{
		try_files \$uri =404;
		fastcgi_pass  unix:/tmp/php-cgi.sock;
		fastcgi_index index.php;
		include fcgi.conf;
	}

	location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
	{
		expires      30d;
	}

	location ~ .*\.(js|css)?$
	{
		expires      12h;
	}

	$al
}
EOF
done

echo -e "Test Nginx configure file........\c"
/usr/local/nginx/sbin/nginx -t
if [ $? != 0 ];then
	echo "[FAILE]"
	exit 1
else
	echo "Restart Nginx....................\c"
	/usr/local/nginx/sbin/nginx -s reload
	if [ $? != 0 ];then
		echo "[FAILE]"
	else
		echo "OK"
fi



